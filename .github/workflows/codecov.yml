name: Code Coverage

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  coverage:
    runs-on: ubuntu-latest
    name: Code Coverage Analysis
    
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: common_admin_test
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=3

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Cache Maven dependencies
        uses: actions/cache@v4
        with:
          path: ~/.m2
          key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
          restore-keys: ${{ runner.os }}-m2

      - name: Wait for MySQL
        run: |
          until mysqladmin ping -h 127.0.0.1 -P 3306 -u root -proot --silent; do
            echo 'Waiting for MySQL to be ready...'
            sleep 5
          done

      - name: Run tests with coverage
        run: |
          cd common-admin-parent
          mvn clean test jacoco:report
        env:
          SPRING_PROFILES_ACTIVE: test

      - name: Generate coverage badge
        uses: cicirello/jacoco-badge-generator@v2
        with:
          jacoco-csv-file: common-admin-parent/target/site/jacoco/jacoco.csv
          badges-directory: .github/badges
          generate-coverage-badge: true
          generate-branches-badge: true

      - name: Upload coverage reports to Codecov
        uses: codecov/codecov-action@v4
        with:
          file: ./common-admin-parent/target/site/jacoco/jacoco.xml
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false

      - name: Upload JaCoCo coverage reports
        uses: actions/upload-artifact@v4
        with:
          name: jacoco-report
          path: common-admin-parent/target/site/jacoco/
          retention-days: 30

      - name: Comment coverage on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            
            // è¯»å–è¦†ç›–ç‡æ•°æ®
            const jacocoXmlPath = './common-admin-parent/target/site/jacoco/jacoco.xml';
            if (fs.existsSync(jacocoXmlPath)) {
              const jacocoXml = fs.readFileSync(jacocoXmlPath, 'utf8');
              
              // ç®€å•è§£æè¦†ç›–ç‡ç™¾åˆ†æ¯”ï¼ˆå®é™…é¡¹ç›®ä¸­å¯èƒ½éœ€è¦æ›´å¤æ‚çš„è§£æï¼‰
              const instructionMatch = jacocoXml.match(/type="INSTRUCTION"[^>]*covered="(\d+)"[^>]*missed="(\d+)"/);
              const branchMatch = jacocoXml.match(/type="BRANCH"[^>]*covered="(\d+)"[^>]*missed="(\d+)"/);
              const lineMatch = jacocoXml.match(/type="LINE"[^>]*covered="(\d+)"[^>]*missed="(\d+)"/);
              
              if (instructionMatch && branchMatch && lineMatch) {
                const instructionCovered = parseInt(instructionMatch[1]);
                const instructionMissed = parseInt(instructionMatch[2]);
                const instructionTotal = instructionCovered + instructionMissed;
                const instructionCoverage = instructionTotal > 0 ? (instructionCovered / instructionTotal * 100).toFixed(2) : 0;
                
                const branchCovered = parseInt(branchMatch[1]);
                const branchMissed = parseInt(branchMatch[2]);
                const branchTotal = branchCovered + branchMissed;
                const branchCoverage = branchTotal > 0 ? (branchCovered / branchTotal * 100).toFixed(2) : 0;
                
                const lineCovered = parseInt(lineMatch[1]);
                const lineMissed = parseInt(lineMatch[2]);
                const lineTotal = lineCovered + lineMissed;
                const lineCoverage = lineTotal > 0 ? (lineCovered / lineTotal * 100).toFixed(2) : 0;
                
                const coverageComment = `
            ## ğŸ“Š ä»£ç è¦†ç›–ç‡æŠ¥å‘Š
            
            | ç±»å‹ | è¦†ç›–ç‡ | è¦†ç›–æ•° / æ€»æ•° |
            |------|--------|---------------|
            | ğŸ¯ æŒ‡ä»¤è¦†ç›–ç‡ | ${instructionCoverage}% | ${instructionCovered} / ${instructionTotal} |
            | ğŸŒ¿ åˆ†æ”¯è¦†ç›–ç‡ | ${branchCoverage}% | ${branchCovered} / ${branchTotal} |
            | ğŸ“ è¡Œè¦†ç›–ç‡ | ${lineCoverage}% | ${lineCovered} / ${lineTotal} |
            
            ### ğŸ“ˆ è¦†ç›–ç‡çŠ¶æ€
            ${instructionCoverage >= 80 ? 'âœ… ä¼˜ç§€' : instructionCoverage >= 70 ? 'âš ï¸ è‰¯å¥½' : 'âŒ éœ€è¦æ”¹è¿›'}
            
            > ğŸ’¡ **å»ºè®®**: ${instructionCoverage < 70 ? 'è¯·å¢åŠ å•å…ƒæµ‹è¯•æ¥æé«˜ä»£ç è¦†ç›–ç‡' : 'ä»£ç è¦†ç›–ç‡è‰¯å¥½ï¼Œç»§ç»­ä¿æŒï¼'}
            
            ğŸ”— [æŸ¥çœ‹è¯¦ç»†æŠ¥å‘Š](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})
                `;
                
                await github.rest.issues.createComment({
                  issue_number: context.issue.number,
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  body: coverageComment
                });
              }
            }

      - name: Coverage Quality Gate
        run: |
          cd common-admin-parent
          # æå–è¦†ç›–ç‡ç™¾åˆ†æ¯”å¹¶æ£€æŸ¥æ˜¯å¦è¾¾åˆ°æœ€ä½è¦æ±‚
          COVERAGE=$(grep -o 'instruction.*>[0-9]*%' target/site/jacoco/index.html | grep -o '[0-9]*' | head -1)
          echo "Code coverage: $COVERAGE%"
          
          if [ "$COVERAGE" -lt 70 ]; then
            echo "âŒ ä»£ç è¦†ç›–ç‡($COVERAGE%)ä½äºæœ€ä½è¦æ±‚(70%)"
            exit 1
          else
            echo "âœ… ä»£ç è¦†ç›–ç‡($COVERAGE%)ç¬¦åˆè¦æ±‚"
          fi 