name: Dependency Update & Security Check

on:
  schedule:
    # æ¯å‘¨ä¸€æ—©ä¸Š8ç‚¹æ£€æŸ¥ä¾èµ–æ›´æ–°
    - cron: '0 8 * * 1'
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  dependency-update:
    runs-on: ubuntu-latest
    name: Check for Dependency Updates
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Cache Maven dependencies
        uses: actions/cache@v4
        with:
          path: ~/.m2
          key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
          restore-keys: ${{ runner.os }}-m2

      - name: Check for dependency updates
        run: |
          cd common-admin-parent
          mvn versions:display-dependency-updates > dependency-updates.txt
          mvn versions:display-plugin-updates >> dependency-updates.txt

      - name: Run security vulnerability check
        run: |
          cd common-admin-parent
          mvn dependency-check:check
        continue-on-error: true

      - name: Create Issue for Updates
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = './common-admin-parent/dependency-updates.txt';
            
            if (fs.existsSync(path)) {
              const content = fs.readFileSync(path, 'utf8');
              
              // æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ–°
              if (content.includes('->')) {
                const issueTitle = `ðŸ“¦ Weekly Dependency Updates - ${new Date().toISOString().split('T')[0]}`;
                const issueBody = `
            ## ðŸ” ä¾èµ–æ›´æ–°æ£€æŸ¥æŠ¥å‘Š
            
            **æ£€æŸ¥æ—¶é—´**: ${new Date().toLocaleString('zh-CN')}
            
            ### ðŸ“‹ æ£€æŸ¥ç»“æžœ
            
            \`\`\`
            ${content}
            \`\`\`
            
            ### ðŸ”§ å»ºè®®æ“ä½œ
            
            1. å®¡æŸ¥ä¸Šè¿°ä¾èµ–æ›´æ–°
            2. æµ‹è¯•å…¼å®¹æ€§
            3. é€æ­¥æ›´æ–°ä¾èµ–ç‰ˆæœ¬
            4. è¿è¡Œå®Œæ•´æµ‹è¯•å¥—ä»¶
            
            ### ðŸ“š æ›´æ–°å‘½ä»¤å‚è€ƒ
            
            \`\`\`bash
            # æ›´æ–°åˆ°æœ€æ–°releaseç‰ˆæœ¬
            mvn versions:use-latest-releases
            
            # æ›´æ–°åˆ°æœ€æ–°ç‰ˆæœ¬ï¼ˆåŒ…æ‹¬å¿«ç…§ï¼‰
            mvn versions:use-latest-versions
            
            # æ›´æ–°ç‰¹å®šä¾èµ–
            mvn versions:use-latest-versions -Dincludes=groupId:artifactId
            \`\`\`
            
            ---
            *æ­¤Issueç”±GitHub Actionsè‡ªåŠ¨åˆ›å»º*
                `;
                
                // æ£€æŸ¥æ˜¯å¦å·²æœ‰ç±»ä¼¼çš„Issue
                const { data: issues } = await github.rest.issues.listForRepo({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  state: 'open',
                  labels: 'dependencies'
                });
                
                const existingIssue = issues.find(issue => 
                  issue.title.includes('Weekly Dependency Updates') && 
                  issue.title.includes(new Date().toISOString().split('T')[0])
                );
                
                if (!existingIssue) {
                  await github.rest.issues.create({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    title: issueTitle,
                    body: issueBody,
                    labels: ['dependencies', 'maintenance']
                  });
                }
              }
            }

      - name: Upload dependency check report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: dependency-reports
          path: |
            common-admin-parent/dependency-updates.txt
            common-admin-parent/target/dependency-check-report.html
          retention-days: 30

  security-advisory:
    runs-on: ubuntu-latest
    name: Security Advisory Check
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Run GitHub Security Advisory Check
        run: |
          # ä½¿ç”¨GitHub CLIæ£€æŸ¥å®‰å…¨å»ºè®®
          gh api graphql -f query='
            query($owner: String!, $repo: String!) {
              repository(owner: $owner, name: $repo) {
                vulnerabilityAlerts(first: 20) {
                  nodes {
                    createdAt
                    securityVulnerability {
                      advisory {
                        summary
                        description
                        severity
                      }
                    }
                  }
                }
              }
            }' -f owner='${{ github.repository_owner }}' -f repo='${{ github.event.repository.name }}'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true 